<!DOCTYPE html>
<html lang="ar">

<head>
  <meta charset="UTF-8">
  <title>تحليل الكلمات حسب المستوى</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    :root {
      --display-box-width: 460px;
      --display-box-height: 120px;
      --letter-size: 55px;
      --main-font-family: 'NotoSansArabic_Condensed-Bold', Arial, sans-serif;
    }

    @font-face {
      font-family: 'NotoSansArabic_Condensed-Bold';
      src: url('fonts/NotoSansArabic_Condensed-Bold.ttf') format('truetype');
      font-weight: normal;
      font-style: normal;
      font-display: swap;
    }

    body {
      margin: 0;
      padding: 0;
      background: url('images/back_a_img.png') no-repeat center center;
      background-size: cover;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: var(--main-font-family);
      direction: rtl;
    }

    .activity-container {
      width: 100%;
      max-width: 1000px;
      height: 80vh;
      max-height: 800px;
      background: #ffffff;
      border-radius: 15px;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
      display: flex;
      overflow: visible;
    }

    .sidebar {
      width: 15%;
      background: #f3e8ff;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-around;
      padding: 15px 10px;
      border-top-right-radius: 15px;
      border-bottom-right-radius: 15px;
    }

    .row {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .stars img {
      width: 30px;
      height: 30px;
      transition: transform .25s ease, filter .25s ease;
    }

    .child-photo img {
      width: 110px;
      height: 110px;
      display: block;
      margin: 0 auto;
      object-fit: cover;
    }

    .student-name p {
      margin: 0;
      font-size: 16px;
      font-weight: bold;
      background: #fff1cc;
      border-radius: 12px;
      padding: 6px 12px;
      display: inline-block;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      text-align: center;
    }

    .timer-controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .timer-controls img {
      width: 40px;
      height: 40px;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .timer-controls img:hover {
      transform: scale(1.1);
    }

    .timer-display {
      font-size: 20px;
      font-weight: bold;
      background: #f779e2;
      border-radius: 8px;
      padding: 5px 10px;
      min-width: 50px;
      height: 35px;
      text-align: center;
      line-height: 35px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .controls {
      display: flex;
      justify-content: center;
      gap: 25px;
      width: 100%;
      margin-top: 20px !important;
    }

    .controls img {
      width: 55px;
      height: 55px;
      cursor: pointer;
      transition: transform .15s ease;
    }

    .controls img:hover {
      transform: scale(1.08);
    }

    .activity-content {
      width: 85%;
      padding: 18px 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-around;
      position: relative;
    }

    .activity-label {
      position: absolute;
      top: -25px;
      left: -25px;
      width: 150px;
      z-index: 5;
    }

    .instructions-icon {
      position: absolute;
      top: 35px;
      left: 25px;
      width: 70px;
      height: 70px;
      cursor: pointer;
      z-index: 15;
      transition: transform 0.2s ease, filter 0.2s ease;
    }

    .instructions-icon:hover {
      transform: scale(1.1);
      filter: drop-shadow(0 0 5px #f779e2);
    }

    .word-display {
      font-size: 48px;
      font-weight: bold;
      color: #333;
      margin-top: 10px;
    }

    .analysis-area {
      width: var(--display-box-width);
      height: var(--display-box-height);
      background: #ffffcc;
      border: 10px solid #ff9966;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
      font-weight: bold;
      color: #0015fc;
      flex-wrap: wrap;
      transition: box-shadow 0.3s ease;
      letter-spacing: 5px;
    }

    .analysis-area.correct-letter {
      box-shadow: 0 0 15px 6px yellow;
    }

    .glowing-box {
      animation: correctGlow 0.8s ease-in-out 2;
    }

    @keyframes correctGlow {
      0% { box-shadow: 0 0 0 #4CAF50; }
      50% { box-shadow: 0 0 25px 8px #4CAF50; }
      100% { box-shadow: 0 0 0 #4CAF50; }
    }

    .letters {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 15px;
      max-width: 635px;
      margin-top: 10px;
      direction: rtl;
    }

    .letter {
      width: 50px;
      height: 50px;
      background: url('images/back_letter.png') no-repeat center center;
      background-size: cover;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 26px;
      font-weight: bold;
      color: white;
      cursor: pointer;
      transition: transform .15s ease;
    }

    .letter:active {
      transform: scale(1.05);
      cursor: grabbing;
    }
  </style>
</head>

<body>
  <div class="activity-container">
    <div class="sidebar">
      <div class="row stars">
        <img id="star1" src="images/star1.png" alt="نجمة1">
        <img id="star2" src="images/star2.png" alt="نجمة2">
        <img id="star3" src="images/star3.png" alt="نجمة3">
      </div>
      <div class="row child-photo">
        <img src="images/child_photo.png" alt="صورة الطفل" id="userPhoto">
      </div>
      <div class="row student-name">
        <p id="userNameDisplay">أحمد محمد</p>
      </div>
      <div class="row timer">
        <div class="timer-controls">
          <img src="images/play.png" alt="Play" id="playBtn">
          <div class="timer-display" id="timer">0</div>
          <img src="images/stop.png" alt="Stop" id="stopBtn">
        </div>
      </div>
      <div class="row controls">
        <img id="homeBtn" src="images/home.png" alt="الرئيسية">
        <img id="retryBtn" src="images/retry.png" alt="إعادة">
      </div>
    </div>

    <div class="activity-content">
      <img src="images/sd_img.png" alt="تعليمات النشاط" class="instructions-icon">
      <img class="activity-label" src="images/actv_3.png" alt="لوجو النشاط">
      <div id="wordDisplay" class="word-display"></div>
      <div id="analysisArea" class="analysis-area"></div>
      <div class="letters" id="lettersGrid"></div>
    </div>
  </div>

  <script>
    // استرجاع بيانات الطفل
    const storedName = sessionStorage.getItem('userName');
    const storedPhoto = sessionStorage.getItem('userImage');
    if (storedName) document.getElementById('userNameDisplay').textContent = storedName;
    if (storedPhoto) document.getElementById('userPhoto').src = storedPhoto;

    // الكلمات حسب المستويات
    const levelsWords = {
      1: [
        { word: "أسد", letters: ['أ', 'س', 'د'], shaped: ['أ', 'سـ', 'د'],soundIndex: 1 },
        { word: "جزر", letters: ['ج', 'ز', 'ر'], shaped: ['جـ', 'ز', 'ر'],soundIndex: 2 },
        { word: "ولد", letters: ['و', 'ل', 'د'], shaped: ['و', 'لـ', 'د'],soundIndex: 3 },
        { word: "بنت", letters: ['ب', 'ن', 'ت'], shaped: ['بـ', 'نـ', 'ت'],soundIndex: 4 },
        { word: "عنب", letters: ['ع', 'ن', 'ب'], shaped: ['عـ', 'نـ', 'ب'],soundIndex: 5 },
        { word: "جمل", letters: ['ج', 'م', 'ل'], shaped: ['جـ', 'مـ', 'ل'],soundIndex: 6 },
        { word: "زرع", letters: ['ز', 'ر', 'ع'], shaped: ['ز', 'ر', 'ع'],soundIndex: 7 },
        { word: "سوق", letters: ['س', 'و', 'ق'], shaped: ['سـ', 'و', 'ق'],soundIndex: 8 },
        { word: "طفل", letters: ['ط', 'ف', 'ل'], shaped: ['طـ', 'فـ', 'ل'],soundIndex: 9 },
        { word: "فيل", letters: ['ف', 'ي', 'ل'], shaped: ['فـ', 'يـ', 'ل'],soundIndex: 10 }
      ],
      2: [
        { word: "قلم", letters: ['ق', 'ل', 'م'], shaped: ['قـ', 'لـ', 'م'],soundIndex: 11 },
        { word: "قمر", letters: ['ق', 'م', 'ر'], shaped: ['قـ', 'مـ', 'ر'],soundIndex: 12 },
        { word: "ورق", letters: ['و', 'ر', 'ق'], shaped: ['و', 'ر', 'ق'],soundIndex: 13 },
        { word: "مركب", letters: ['م', 'ر','ك','ب'], shaped: ['مـ', 'ر', 'كـ', 'ب'],soundIndex: 14 },
        { word: "مترو", letters:['م', 'ت', 'ر', 'و'], shaped: ['مـ', 'تـ', 'ر', 'و'],soundIndex: 15 },
        { word: "بطة", letters: ['ب', 'ط', 'ة'], shaped: ['بـ', 'طـ', 'ـة'],soundIndex: 16 },
        { word: "دب", letters: ['د', 'ب'], shaped: ['د', 'ب'],soundIndex: 17 },
        { word: "شمس", letters: ['ش', 'م', 'س'], shaped: ['شـ', 'مـ', 'س'],soundIndex: 18 },
        { word: "قطة", letters: ['ق', 'ط', 'ة'], shaped: ['قـ', 'طـ', 'ـة'],soundIndex: 19 },
        { word: "خس", letters: ['خ', 'س'], shaped: ['خـ', 'س'],soundIndex: 20 }
      ],
      3: [
        { word: "سمكة", letters: ['س', 'م', 'ك', 'ة'], shaped: ['سـ', 'مـ', 'كـ', 'ـة'],soundIndex: 21 },
        { word: "كرسي", letters: ['ك', 'ر', 'س', 'ي'], shaped: ['كـ', 'ر', 'سـ', 'ي'],soundIndex: 22 },
        { word: "شورت", letters: ['ش', 'و', 'ر', 'ت'], shaped: ['شـ', 'و', 'ر', 'ت'],soundIndex: 23 },
        { word: "خروف", letters: ['خ', 'ر', 'و', 'ف'], shaped: ['خـ', 'ر', 'و', 'ف'],soundIndex: 24 },
        { word: "أرنب", letters: ['أ', 'ر', 'ن', 'ب'], shaped: ['أ', 'ر', 'نـ', 'ب'],soundIndex: 25 },
        { word: "بحر", letters: ['ب', 'ح', 'ر'], shaped: ['بـ', 'حـ', 'ر'],soundIndex: 26 },
        { word: "ورد", letters: ['و', 'ر', 'د'], shaped: ['و', 'ر', 'د'],soundIndex: 27 },
        { word: "توت", letters: ['ت', 'و', 'ت'], shaped: ['تـ', 'و',  'ت'],soundIndex: 28 },
        { word: "فلفل", letters: ['ف', 'ل', 'ف', 'ل'], shaped: ['فـ', 'لـ', 'فـ', 'ل'],soundIndex: 29 },
        { word: "ديك", letters: ['د', 'ي', 'ك'], shaped: ['د', 'يـ', 'ك'],soundIndex: 30 }
      ]
    };

    const arabicLetters = ['أ','ا','ب','ت','ث','ج','ح','خ','د','ذ','ر','ز','س','ش','ص','ض','ط','ظ','ع','غ','ف','ق','ك','ل','م','ن','هـ','ة','و','ي'];

    // الحصول على المستوى المختار من sessionStorage وتحويله للرقم
    const levelMap = { 'A': 1, 'B': 2, 'C': 3 };
    const selectedLevel = sessionStorage.getItem('selectedLevel') || 'A';
    const currentLevel = levelMap[selectedLevel];

    let words = [...levelsWords[currentLevel]]; // نسخ الكلمة الحالية للمستوى
    let wordQueue = []; // ترتيب عشوائي للكلمات مع ضمان عدم التكرار حتى تمر كلها

    let currentWord = {}, currentWordIndex = 0, placedLetters = [], correctAnswers = 0;
    const starElems = [], initialStarSrc = ['images/star1.png','images/star2.png','images/star3.png'], highlightStarSrc = 'images/star_red.png';
    let dropAreaEl = null;

    function playSoundSafe(src) { try { new Audio(src).play().catch(() => {}); } catch(e) {} }

    // دالة shuffle
    function shuffleArray(array){
      for(let i=array.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [array[i],array[j]]=[array[j],array[i]];
      }
      return array;
    }

    function setupWordQueue(){
      wordQueue = shuffleArray([...words]);
    }

    function setupNewWord() {
      if(wordQueue.length===0) setupWordQueue(); // إعادة ملء القائمة بعد مرور جميع الكلمات

      currentWord = wordQueue.pop(); // أخذ كلمة جديدة
      placedLetters = [];
      document.getElementById('wordDisplay').textContent = currentWord.word;
      dropAreaEl.textContent = '';

      const grid = document.getElementById('lettersGrid');
      grid.innerHTML = '';

      // عرض جميع الحروف العربية بشكل ثابت ومرتب
      arabicLetters.forEach(letter => {
        const div = document.createElement('div');
        div.className = 'letter';
        div.textContent = letter;
        div.draggable = true;
        div.addEventListener('dragstart', e => e.dataTransfer.setData('text/plain', letter));
        grid.appendChild(div);
      });
    }

    function handleDrop(e){
      e.preventDefault();
      const droppedLetter = e.dataTransfer.getData('text/plain');
      if(!droppedLetter) return;
      const expectedLetter = currentWord.letters[placedLetters.length];

      if(droppedLetter === expectedLetter){
        placedLetters.push(droppedLetter);
        const shapedLetters = currentWord.shaped.slice(0, placedLetters.length);
        dropAreaEl.innerHTML = '';
        shapedLetters.forEach(letter => {
          const span = document.createElement('span');
          span.textContent = letter;
          span.style.margin='0 5px';
          dropAreaEl.appendChild(span);
        });
        dropAreaEl.classList.add('correct-letter');
        setTimeout(()=>dropAreaEl.classList.remove('correct-letter'),500);
        playSoundSafe('sounds/correct.mp3');

        if(placedLetters.length === currentWord.letters.length){

           playSoundSafe(`sounds/word${currentWord.soundIndex}.mp3`);
         
         //  playSoundSafe(`sounds/word${currentWordIndex+1}.mp3`);
          dropAreaEl.classList.add('glowing-box');
          correctAnswers++;
          updateSidebarStarsByProgress();
          setTimeout(()=>{ dropAreaEl.classList.remove('glowing-box'); setupNewWord(); }, 1800);
        }
      } else playSoundSafe('sounds/wrong.mp3');
    }

    function animateStar(starEl){ starEl.style.transform='translateX(15px) scale(1.25)'; setTimeout(()=>starEl.style.transform='',250); }

    function updateSidebarStarsByProgress(){
      const thresholds = [3,6,9];
      thresholds.forEach((t,idx)=>{
        if(correctAnswers>=t && starElems[idx] && !starElems[idx].dataset.activated){
          starElems[idx].src = highlightStarSrc;
          starElems[idx].dataset.activated='1';
          animateStar(starElems[idx]);
        }
      });
    }

    function resetActivity(){
      correctAnswers=0;
      starElems.forEach((s,i)=>{ s.src=initialStarSrc[i]; delete s.dataset.activated; s.style.transform=''; });
      setupWordQueue();
      setupNewWord();
    }

    document.addEventListener('DOMContentLoaded',()=>{
      dropAreaEl=document.getElementById('analysisArea');
      const homeBtn=document.getElementById('homeBtn');
      const retryBtn=document.getElementById('retryBtn');
      starElems.push(document.getElementById('star1'),document.getElementById('star2'),document.getElementById('star3'));
      if(homeBtn) homeBtn.addEventListener('click',()=>window.location.href='activities.html');
      retryBtn.addEventListener('click',()=>{ clearInterval(timerInterval); timerInterval=null; counter=0; timerDisplay.textContent=counter; resetActivity(); });
      dropAreaEl.addEventListener('dragover',e=>e.preventDefault());
      dropAreaEl.addEventListener('drop',handleDrop);
      setupWordQueue();
      setupNewWord();
    });

    document.addEventListener('contextmenu', e=>e.preventDefault());
    document.querySelector('.instructions-icon').addEventListener('click',()=>{ new Audio('sounds/sd3_sound.mp3').play().catch(e=>{}); });

    let timerInterval, counter=0;
    const timerDisplay=document.getElementById('timer');
    document.getElementById('playBtn').addEventListener('click',()=>{ clearInterval(timerInterval); timerInterval=setInterval(()=>{ counter++; timerDisplay.textContent=counter; },1000); });
    document.getElementById('stopBtn').addEventListener('click',()=>clearInterval(timerInterval));
  </script>
</body>
</html>
